<!-- templates/calendar.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Project Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar CSS & JS -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script>
        tailwind.config = {
          darkMode: 'class'
        };
      </script>

    <!-- Dark Mode Styling -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .fc {
            background-color: white;
        }
        .dark .fc {
            background-color: #1f2937;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 shadow-md p-4 hidden md:block md:flex-shrink-0">
            {% if request.user.role == 'admin' %} 
            <h2 class="text-2xl font-bold mb-6" id="role-title">🛠️ Admin</h2>
            
            {% elif request.user.role == 'manager' %}
            <h2 class="text-2xl font-bold mb-6" id="role-title">📂 Manager</h2>
            
            {% else %}
            <h2 class="text-2xl font-bold mb-6" id="role-title">💻 Developer</h2>
    
    
            {% endif %}
          <!-- <h2 class="text-2xl font-bold mb-6" id="role-title">🔧 Admin</h2> -->
          <nav class="space-y-4 text-sm">
            <a href="/" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">🏠 Home</a>
            
    
            <a href="/projects" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">📁 Projects</a>
            <a href="/calender_page" class="block px-3 py-2 rounded bg-gray-200 dark:bg-gray-700 font-medium text-gray-900 dark:text-white">🗓️ Calendar</a>
            <a href="/chat" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">💬 Chat</a>
            <!-- <a href="#" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">📊 Reports</a> -->
            <a href="/notifications_view" class="relative block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">
              🔔 Notifications
              <span id="unread-badge" class="absolute top-1 right-2 bg-red-600 text-white font-semibold px-2 py-0.5 rounded-full hidden" style="line-height:1.5rem; font-size:0.75rem;">0</span>
            </a>
            <div class="relative">
              <button onclick="toggleSettings()" id="settings-menu" class="w-full text-left block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">
                  ⚙️ Settings
              </button>
              <div id="settings-dropdown" class="absolute left-0 mt-1 w-48 bg-white dark:bg-gray-800 shadow-lg rounded-md hidden z-50">
                  {% if request.user.role == 'admin' %}
                  <a href="/users" class="block px-4 py-2 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">👥 Manage Users</a>
                  {% endif %}
                  <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-red-400">🚪 Logout</a>
              </div>
          </div>
          </nav>
        </aside>
    
        <!-- Main content -->
        <main class="flex-1 overflow-y-auto p-4 bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
    
          <!-- Mobile Menu Button -->
          <div class="md:hidden mb-4">
            <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="px-3 py-2 bg-gray-800 text-white rounded">
              ☰ Menu
            </button>
          </div>
    
          <!-- Dark Mode Toggle -->
          <div class="flex justify-end mb-4">
            <button onclick="toggleDarkMode()" class="px-3 py-2 bg-gray-300 dark:bg-gray-700 text-sm rounded">
              🌞 / 🌙 Toggle Mode
            </button>
          </div>

    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6 text-center">📅 Project Calendar</h1>
        
        <!-- Calendar container -->
        <div id="calendar" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"></div>
    </div>
    <div id="ai-assistant-button" class="fixed bottom-4 right-4 z-50">
      <button onclick="toggleAIAssistant()" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none">
        🤖
      </button>
    </div>
    
    <!-- AI Assistant Chat Box -->
    <div id="ai-assistant-box" class="fixed bottom-20 right-4 w-80 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-lg z-50 hidden">
      <div class="flex justify-between items-center bg-blue-600 text-white px-4 py-2 rounded-t-lg">
        <h3 class="font-semibold">AI Assistant</h3>
        <button onclick="toggleAIAssistant()" class="text-white hover:text-gray-200">✖</button>
      </div>
      <div id="ai-chat-log" class="p-4 max-h-60 overflow-y-auto text-sm space-y-2 text-gray-800 dark:text-gray-100">
        <p class="text-gray-500 dark:text-gray-400 italic">Ask me anything about your tasks or projects...</p>
      </div>
      <form onsubmit="sendAIMessage(event)" class="flex items-center p-2 border-t dark:border-gray-700">
        <input id="ai-user-input" type="text" placeholder="Type a message..." class="flex-1 px-2 py-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm focus:outline-none">
        <button type="submit" class="ml-2 text-blue-600 dark:text-blue-400 font-bold">Send</button>
      </form>
    </div>

    <!-- Calendar Script -->
    <script>
        function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
    
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 650,
                themeSystem: 'standard',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    fetch('/get-calendar-events')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Fetched calendar data:', data); // ✅ Log the received event data
                            successCallback(data);
                        })
                        .catch(error => {
                            console.error('Error fetching calendar events:', error); // ❌ Log fetch errors
                            failureCallback(error);
                        });
                },
                eventClick: function (info) {
                    alert('Task: ' + info.event.title + '\nDeadline: ' + info.event.start.toLocaleDateString());
    
                    // Open event link in a new tab if provided
                    if (info.event.url) {
                        window.open(info.event.url, '_blank');
                    }
    
                    info.jsEvent.preventDefault(); // Prevent default browser behavior
                }
            });
    
            calendar.render();
        });
        function toggleAIAssistant() {
  const chatBox = document.getElementById("ai-assistant-box");
  chatBox.classList.toggle("hidden");
}

async function sendAIMessage(event) {
  event.preventDefault();
  const input = document.getElementById("ai-user-input");
  const message = input.value.trim();
  if (!message) return;

  const chatLog = document.getElementById("ai-chat-log");
  chatLog.innerHTML += `<div class="text-right"><strong>You:</strong> ${message}</div>`;
  input.value = "";

  try {
    const response = await fetch("/ai_assistant", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ message })
    });

    const data = await response.json();
    chatLog.innerHTML += `<div><strong>AI:</strong> ${data.reply}</div>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch (error) {
    chatLog.innerHTML += `<div class="text-red-500">Error fetching AI response.</div>`;
  }
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
function toggleSettings() {
        const dropdown = document.getElementById("settings-dropdown");
        dropdown.classList.toggle("hidden");
    }
    document.addEventListener("click", function (event) {
        const button = document.getElementById("settings-menu");
        const dropdown = document.getElementById("settings-dropdown");
        if (!button.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add("hidden");
        }
    });

    </script>
    
    
</body>
</html>
