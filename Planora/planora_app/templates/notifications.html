<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Notifications</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
  <div class="flex h-screen overflow-hidden">
  
    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-gray-800 shadow-md p-4 hidden md:block md:flex-shrink-0">
      {% if request.user.role == 'admin' %} 
      <h2 class="text-2xl font-bold mb-6" id="role-title">ğŸ› ï¸ Admin</h2>
      {% elif request.user.role == 'manager' %}
      <h2 class="text-2xl font-bold mb-6" id="role-title">ğŸ“‚ Manager</h2>
      {% else %}
      <h2 class="text-2xl font-bold mb-6" id="role-title">ğŸ’» Developer</h2>
      {% endif %}

      <nav class="space-y-4 text-sm">
        <a href="/" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">ğŸ  Home</a>
        <a href="/projects" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300  ">ğŸ“ Projects</a>
        <a href="/calender_page" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300 ">ğŸ—“ï¸ Calendar</a>
        <a href="/chat" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">ğŸ’¬ Chat</a>
        <!-- <a href="#" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">ğŸ“Š Reports</a> -->
        <a href="/notifications_view" class="block px-3 py-2 rounded bg-gray-200 dark:bg-gray-700 font-medium text-gray-900 dark:text-white">
          ğŸ”” Notifications
          <span id="unread-badge" class="absolute top-1 right-2 bg-red-600 text-white font-semibold px-2 py-0.5 rounded-full hidden" style="line-height:1.5rem; font-size:0.75rem;">0</span>
        </a>
        <div class="relative">
          <button onclick="toggleSettings()" id="settings-menu" class="w-full text-left block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">
              âš™ï¸ Settings
          </button>
          <div id="settings-dropdown" class="absolute left-0 mt-1 w-48 bg-white dark:bg-gray-800 shadow-lg rounded-md hidden z-50">
              {% if request.user.role == 'admin' %}
              <a href="/users" class="block px-4 py-2 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">ğŸ‘¥ Manage Users</a>
              {% endif %}
              <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-red-400">ğŸšª Logout</a>
          </div>
      </div>
      </nav>
    </aside>
    <div class="max-w-3xl mx-auto p-6">
        <h2 class="text-2xl font-bold mb-4">ğŸ”” Notifications</h2>

        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
            {% if notifications %}
                <ul class="space-y-4">
                    {% for note in notifications %}
                        <li class="p-3 rounded {{ note.is_read|yesno:'bg-gray-100 dark:bg-gray-700,bg-yellow-100 dark:bg-yellow-900' }}"
                            data-task-id="{{ note.related_task.id }}" data-note-id="{{ note.id }}">
                            <p class="text-base font-medium">{{ note.message }}</p>
                            <p class="text-xs text-gray-500">{{ note.created_at|timesince }} ago</p>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
            <div class="text-center py-6 text-gray-500 dark:text-gray-400">
            <p>No notifications yet. ğŸ‰</p>
            {% endif %}
        </div>
    </div>
    <div id="ai-assistant-button" class="fixed bottom-4 right-4 z-50">
        <button onclick="toggleAIAssistant()" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none">
          ğŸ¤–
        </button>
      </div>
      
      <!-- AI Assistant Chat Box -->
      <div id="ai-assistant-box" class="fixed bottom-20 right-4 w-80 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-lg z-50 hidden">
        <div class="flex justify-between items-center bg-blue-600 text-white px-4 py-2 rounded-t-lg">
          <h3 class="font-semibold">AI Assistant</h3>
          <button onclick="toggleAIAssistant()" class="text-white hover:text-gray-200">âœ–</button>
        </div>
        <div id="ai-chat-log" class="p-4 max-h-60 overflow-y-auto text-sm space-y-2 text-gray-800 dark:text-gray-100">
          <p class="text-gray-500 dark:text-gray-400 italic">Ask me anything about your tasks or projects...</p>
        </div>
        <form onsubmit="sendAIMessage(event)" class="flex items-center p-2 border-t dark:border-gray-700">
          <input id="ai-user-input" type="text" placeholder="Type a message..." class="flex-1 px-2 py-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm focus:outline-none">
          <button type="submit" class="ml-2 text-blue-600 dark:text-blue-400 font-bold">Send</button>
        </form>
      </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const notificationItems = document.querySelectorAll('li[data-task-id]');

            notificationItems.forEach(item => {
                const taskId = item.getAttribute('data-task-id');
                const noteId = item.getAttribute('data-note-id');
                item.addEventListener('click', () => {
                    fetch('/mark_as_read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'  
                        },
                        body: JSON.stringify({
                            note_id: noteId,
                            task_id: taskId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Marked as read:', data);
                        window.open(`/view_task/${taskId}`, '_blank'); 
                        window.location.reload();

                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });
        });
        function toggleAIAssistant() {
  const chatBox = document.getElementById("ai-assistant-box");
  chatBox.classList.toggle("hidden");
}

async function sendAIMessage(event) {
  event.preventDefault();
  const input = document.getElementById("ai-user-input");
  const message = input.value.trim();
  if (!message) return;

  const chatLog = document.getElementById("ai-chat-log");
  chatLog.innerHTML += `<div class="text-right"><strong>You:</strong> ${message}</div>`;
  input.value = "";

  try {
    const response = await fetch("/ai_assistant", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ message })
    });

    const data = await response.json();
    chatLog.innerHTML += `<div><strong>AI:</strong> ${data.reply}</div>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch (error) {
    chatLog.innerHTML += `<div class="text-red-500">Error fetching AI response.</div>`;
  }
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
function toggleSettings() {
        const dropdown = document.getElementById("settings-dropdown");
        dropdown.classList.toggle("hidden");
    }
    document.addEventListener("click", function (event) {
        const button = document.getElementById("settings-menu");
        const dropdown = document.getElementById("settings-dropdown");
        if (!button.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add("hidden");
        }
    });

    </script>
</body>
</html>
