<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <title>Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    };
  </script>

  <!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-gray-800 shadow-md p-4 hidden md:block md:flex-shrink-0">
        {% if manager_role == 'admin' %} 
        <h2 class="text-2xl font-bold mb-6" id="role-title">🛠️ Admin</h2>
        
        {% elif manager_role == 'manager' %}
        <h2 class="text-2xl font-bold mb-6" id="role-title">📂 Manager</h2>
        
        {% else %}
        <h2 class="text-2xl font-bold mb-6" id="role-title">💻 Developer</h2>


        {% endif %}
      <!-- <h2 class="text-2xl font-bold mb-6" id="role-title">🔧 Admin</h2> -->
      <nav class="space-y-4 text-sm">
        <a href="/" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">🏠 Home</a>
        

        <a href="/projects" class="block px-3 py-2 rounded bg-gray-200 dark:bg-gray-700 font-medium text-gray-900 dark:text-white">📁 Projects</a>
        <a href="/calender_page" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">🗓️ Calendar</a>
        <a href="/chat" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">💬 Chat</a>
        <!-- <a href="#" class="block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">📊 Reports</a> -->
        <a href="/notifications_view" class="relative block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium text-gray-700 dark:text-gray-300">
            🔔 Notifications
            <span id="unread-badge" class="absolute top-1 right-2 bg-red-600 text-white font-semibold px-2 py-0.5 rounded-full hidden" style="line-height:1.5rem; font-size:0.75rem;">0</span>
          </a>
          <div class="relative">
            <button onclick="toggleSettings()" id="settings-menu" class="w-full text-left block px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">
                ⚙️ Settings
            </button>
            <div id="settings-dropdown" class="absolute left-0 mt-1 w-48 bg-white dark:bg-gray-800 shadow-lg rounded-md hidden z-50">
                {% if request.user.role == 'admin' %}
                <a href="/users" class="block px-4 py-2 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">👥 Manage Users</a>
                {% endif %}
                <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-red-400">🚪 Logout</a>
            </div>
        </div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 overflow-y-auto p-4 bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

      <!-- Mobile Menu Button -->
      <div class="md:hidden mb-4">
        <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="px-3 py-2 bg-gray-800 text-white rounded">
          ☰ Menu
        </button>
      </div>

      <!-- Dark Mode Toggle -->
      <div class="flex justify-end mb-4">
        <button onclick="toggleDarkMode()" class="px-3 py-2 bg-gray-300 dark:bg-gray-700 text-sm rounded">
          🌞 / 🌙 Toggle Mode
        </button>
      </div>

      <!-- Page Title -->
      <div class="max-w-7xl mx-auto">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">📁 Projects</h1>
    {% if manager_role == 'admin' %}
    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow-md">
      ➕ Create Project
    </button>
    {% endif %}
  </div>

  <!-- Project Grid -->
  <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for project in projects %}
    <div class="bg-white dark:bg-gray-800 shadow-lg p-5 rounded-xl hover:shadow-xl transition-all relative">
      <h2 class="text-lg font-bold text-gray-900 dark:text-white cursor-pointer"
          onclick="goToDashboard('{{ project.id }}', '{{ manager_role }}')">
        {{ project.name }}
      </h2>
      <p class="text-gray-600 font-semibold">Managed by: {{ project.manager.username }}</p>
      <p class="text-gray-700 dark:text-gray-300 mt-2">{{ project.description }}</p>
      <p class="text-gray-500 text-sm mt-2">Created: {{ project.created_at }}</p>
      <p class="text-gray-500 text-sm mt-2">Due: {{ project.due_date }}</p>
            {% if project.active_zoom %}
      <a href="{{ project.active_zoom }}" target="_blank"
         class="inline-block mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        📡 Join Zoom
      </a>
    {% else %}
      <span class="text-sm text-gray-400 italic">No active Zoom meeting</span>
    {% endif %}

      {% if manager_role == 'admin' %}
      <!-- Ellipsis menu button -->
      <button class="text-gray-700 dark:text-white absolute top-3 right-3 text-gray-600 hover:text-gray-900" id="menu-btn"
              onclick="toggleMenu('{{ project.id }}')">
        ⋮
      </button>

      <!-- Dropdown menu -->
      <div id="menu-{{ project.id }}"
           class="text-gray-700 dark:text-white menudropdown absolute top-10 right-3 bg-white dark:bg-gray-700 shadow-lg rounded-lg p-2 z-10 hidden">
        <button class="block w-full text-left px-3 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-white"
                onclick="editProject('{{ project.id }}', '{{ project.name }}', '{{ project.description }}', '{{ project.due_date }}')">
          ✏ Edit
        </button>
        <button class="block w-full text-left px-3 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 text-red-600"
                onclick="deleteProject(event, '{{ project.id }}')">
          🗑 Delete
        </button>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p class="text-gray-600 text-center col-span-3">No projects available.</p>
    {% endfor %}
  </div>
</div>
<div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100" id="modal-title">Create Project</h2>
      <form method="POST" onsubmit="handleEvent(event)" id="editProjectForm">
        {% csrf_token %}
        <input type="hidden" id="id" name="project_id" value="">
        <div class="mb-4">
          <label class="block text-gray-700 dark:text-gray-300">Project Title</label>
          <input type="text" id="title" name="title" class="w-full p-2 rounded mb-4 border border-gray-300 bg-white text-gray-800 
          dark:bg-gray-700 dark:text-white dark:border-gray-600" required>
          
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 dark:text-gray-300">Project Description</label>
          <textarea name="description" id="description" class="w-full p-2 rounded mb-4 border border-gray-300 bg-white text-gray-800 
          dark:bg-gray-700 dark:text-white dark:border-gray-600" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 dark:text-gray-300">Due Date</label>
          <input type="date" name="due_date" id="due_date" class="w-full p-2 rounded mb-4 border border-gray-300 bg-white text-gray-800 
          dark:bg-gray-700 dark:text-white dark:border-gray-600" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 dark:text-gray-300">Assign Manager</label>
          <select name="manager" id="manager" class="w-full p-2 rounded mb-4 border border-gray-300 bg-white text-gray-800 
          dark:bg-gray-700 dark:text-white dark:border-gray-600">
            {% for manager in managers %}
            <option value="{{ manager.username }}">{{ manager.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 dark:text-gray-300">Assign Developers</label>
          <select id="developers" name="developers" multiple placeholder="Select developers...">
            {% for developer in developers %}
              <option value="{{ developer.username }}" style="color:black">{{ developer.username }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="flex justify-end">
          <button type="button" onclick="closeModal()" class="mr-2 px-4 py-2 bg-gray-400 text-white rounded-lg">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-800 text-white rounded-lg" id="save_btn">Save</button>
        </div>
      </form>
    </div>
  </div>
  <div id="ai-assistant-button" class="fixed bottom-4 right-4 z-50">
    <button onclick="toggleAIAssistant()" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none">
      🤖
    </button>
  </div>
  <div id="ai-assistant-box" class="fixed bottom-20 right-4 w-80 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-lg z-50 hidden">
    <div class="flex justify-between items-center bg-blue-600 text-white px-4 py-2 rounded-t-lg">
      <h3 class="font-semibold">AI Assistant</h3>
      <button onclick="toggleAIAssistant()" class="text-white hover:text-gray-200">✖</button>
    </div>
    <div id="ai-chat-log" class="p-4 max-h-60 overflow-y-auto text-sm space-y-2 text-gray-800 dark:text-gray-100">
      <p class="text-gray-500 dark:text-gray-400 italic">Ask me anything about your tasks or projects...</p>
    </div>
    <form onsubmit="sendAIMessage(event)" class="flex items-center p-2 border-t dark:border-gray-700">
      <input id="ai-user-input" type="text" placeholder="Type a message..." class="flex-1 px-2 py-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm focus:outline-none">
      <button type="submit" class="ml-2 text-blue-600 dark:text-blue-400 font-bold">Send</button>
    </form>
  </div>
  
  <script>
       function toggleSettings() {
        const dropdown = document.getElementById("settings-dropdown");
        dropdown.classList.toggle("hidden");
    }
    document.addEventListener("click", function (event) {
      console.log("inside")
        const button = document.getElementById("settings-menu");
        const dropdown = document.getElementById("settings-dropdown");
        if (!button.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add("hidden");
        }
    });
     async function fetchUnreadNotifications() {
    try {
      const response = await fetch('/get_unread_notification_count');
      const data = await response.json();
      if (data.unread_count > 0) {
        const badge = document.getElementById("unread-badge");
        badge.textContent = data.unread_count;
        badge.classList.remove("hidden");
      }
    } catch (error) {
      console.error("Failed to load unread notifications:", error);
    }
  }
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
    fetchUnreadNotifications();
    function goToDashboard(projectId, userRole) {
        fetch('/dashboard', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ project_id: projectId, role: userRole })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data)
            project_id = data.project_id;
            window.location.href = `/admin_dashboard/${project_id}`;


        })
        .catch(error => console.error('Error:', error));
    }
        function toggleMenu(projectId) {
    let menu = document.getElementById(`menu-${projectId}`);
    
    document.querySelectorAll(".menudropdown").forEach((dropdown) => {
        if (dropdown !== menu) {
            dropdown.style.display = "none";
        }
    });

    menu.style.display = (menu.style.display === "none" || menu.style.display === "") ? "block" : "none";

    document.addEventListener("click", function closeMenu(event) {
        if (!menu.contains(event.target) && !event.target.closest(`#menu-btn`)) {
            menu.style.display = "none";
            document.removeEventListener("click", closeMenu);
        }
    });
}
function openModal() {
            document.getElementById('projectModal').classList.remove('hidden');
        }
        function closeModal() {
            document.getElementById('projectModal').classList.add('hidden');
        }
        function editProject(projectId, name, description, dueDate) {
            console.log(dueDate) // April 17, 2025, midnight
            let cleanedDate = dueDate.replace('midnight', '00:00');

        const parsedDate = new Date(cleanedDate);

        // Format to dd/mm/yyyy
        const yyyy = parsedDate.getFullYear();
        const mm = String(parsedDate.getMonth() + 1).padStart(2, '0');
        const dd = String(parsedDate.getDate()).padStart(2, '0');

        const isoFormattedDate = `${yyyy}-${mm}-${dd}`;

        // const formattedDate = `${day}/${month}/${year}`;
        console.log(isoFormattedDate); // 17/04/2025

    console.log("Editing project:", projectId);

    let menu = document.getElementById(`menu-${projectId}`);
    if (menu) {
        menu.style.display = "none";
    }
    document.getElementById('projectModal').classList.remove('hidden');
    document.getElementById('id').value = projectId;
    document.getElementById('title').value = name;
    document.getElementById('description').value = description;
    console.log(dueDate) // April 17, 2025, midnight
    document.getElementById('due_date').value = isoFormattedDate;
}
function updateProject(projectId) {
    const formData = new FormData(document.getElementById("editProjectForm"));

    fetch(`/update_project/${projectId}/`, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(error => console.error("Error:", error));
}
function deleteProject(event, projectId) {

if (confirm("Are you sure you want to delete this project?")) {
    fetch(`/delete_project/${projectId}`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(error => console.error('Error:', error));
}
}
function closeMenu(event, menu) {
menu.style.display = "none";
}
function handleEvent(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        let projectId = document.getElementById("id").value;

        fetch('/create_project', {
            method: 'POST',
            body: formData,

        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Error: " + data.error);
            } else {
                alert("Success: " + data.message);
                window.location.href = "/projects";  
            }
        })
        .catch(error => console.error('Error:', error));
    }
    function goToDashboard(projectId, userRole) {
        fetch('/dashboard', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ project_id: projectId, role: userRole })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data)
            project_id = data.project_id;
            window.location.href = `/admin_dashboard/${project_id}`;


        })
        .catch(error => console.error('Error:', error));
    }
    function toggleAIAssistant() {
  const chatBox = document.getElementById("ai-assistant-box");
  chatBox.classList.toggle("hidden");
}

async function sendAIMessage(event) {
  event.preventDefault();
  const input = document.getElementById("ai-user-input");
  const message = input.value.trim();
  if (!message) return;

  const chatLog = document.getElementById("ai-chat-log");
  chatLog.innerHTML += `<div class="text-right"><strong>You:</strong> ${message}</div>`;
  input.value = "";

  try {
    const response = await fetch("/ai_assistant", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ message })
    });

    const data = await response.json();
    chatLog.innerHTML += `<div><strong>AI:</strong> ${data.reply}</div>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch (error) {
    chatLog.innerHTML += `<div class="text-red-500">Error fetching AI response.</div>`;
  }
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
document.addEventListener("DOMContentLoaded", function () {
    new TomSelect("#developer-select", {
      plugins: ['remove_button'],
      create: false,
      maxItems: null,
    });
  });
  </script>
</body>
</html>